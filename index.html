<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taller PETI 2027 â€” Grupo Virtual</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --navy:#1A2E4A;--teal:#0D7C8E;--orange:#E07B39;--purple:#6D28D9;
  --green:#16A34A;--yellow:#CA8A04;--red:#DC2626;--amber:#D97706;
  --bg:#F0F4F8;--card:#FFFFFF;--border:#E2E8F0;--text:#1E293B;--muted:#64748B;
  --green-bg:#F0FDF4;--green-bd:#86EFAC;
  --yellow-bg:#FEFCE8;--yellow-bd:#FDE047;
  --red-bg:#FFF1F2;--red-bd:#FCA5A5;
  --amber-bg:#FFF7ED;--amber-bd:#FCD34D;
  --purple-bg:#F5F3FF;--purple-bd:#C4B5FD;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
nav{position:sticky;top:0;z-index:100;background:var(--navy);display:flex;align-items:center;padding:0 22px;box-shadow:0 2px 12px rgba(0,0,0,.28);}
.nav-brand{font-size:13px;font-weight:700;color:#fff;padding:12px 18px 12px 0;border-right:1px solid rgba(255,255,255,.15);margin-right:8px;white-space:nowrap;line-height:1.4;}
.nav-brand span{color:var(--orange);}
.nav-sub{font-size:10px;color:rgba(255,255,255,.45);font-weight:400;display:block;}
.nav-tabs{display:flex;}
.tab-btn{background:none;border:none;cursor:pointer;color:rgba(255,255,255,.5);font-family:inherit;font-size:13px;font-weight:500;padding:16px 15px;position:relative;transition:color .2s;white-space:nowrap;}
.tab-btn:hover{color:rgba(255,255,255,.85);}
.tab-btn.active{color:#fff;}
.tab-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--orange);border-radius:3px 3px 0 0;}
.tab-num{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:rgba(255,255,255,.15);font-size:11px;font-weight:700;margin-right:6px;}
.tab-btn.active .tab-num{background:var(--orange);}
.nav-right{margin-left:auto;}
.plenaria-btn{background:var(--orange);color:#fff;border:none;border-radius:8px;padding:7px 15px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;transition:background .2s;white-space:nowrap;}
.plenaria-btn:hover{background:#c96a28;}
.save-pill{position:fixed;bottom:18px;left:18px;z-index:500;background:var(--navy);color:#fff;padding:6px 13px;border-radius:20px;font-size:11px;font-weight:600;display:flex;align-items:center;gap:6px;opacity:0;transition:opacity .4s;pointer-events:none;}
.save-pill.show{opacity:1;}
.save-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
main{max-width:1200px;margin:0 auto;padding:26px 22px;}
.page{display:none;}
.page.active{display:block;animation:fadeIn .22s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:none;}}
.page-header{background:var(--card);border-radius:14px;padding:20px 26px;border-left:5px solid var(--teal);margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;box-shadow:0 1px 4px rgba(0,0,0,.07);}
.page-header h1{font-size:19px;font-weight:700;color:var(--navy);}
.page-header p{font-size:13px;color:var(--muted);margin-top:3px;}
.badge{font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px;background:var(--teal);color:#fff;white-space:nowrap;}
.btn-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.progress-bar{height:4px;background:var(--border);border-radius:2px;margin-top:8px;}
.progress-fill{height:100%;border-radius:2px;transition:width .4s ease;}
.card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.07);border:1px solid var(--border);}
.card-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:14px;}
.reset-btn{background:none;border:1px solid var(--border);border-radius:8px;padding:7px 13px;cursor:pointer;font-family:inherit;font-size:12px;color:var(--muted);transition:all .2s;}
.reset-btn:hover{border-color:var(--red);color:var(--red);}
.export-btn{background:var(--navy);color:#fff;border:none;border-radius:8px;padding:9px 17px;cursor:pointer;font-family:inherit;font-size:13px;font-weight:600;transition:background .2s;display:flex;align-items:center;gap:6px;white-space:nowrap;}
.export-btn:hover{background:var(--teal);}
.export-block{background:var(--card);border:2px dashed var(--border);border-radius:12px;padding:15px 20px;margin-top:18px;display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;}
.export-block strong{font-size:14px;color:var(--navy);}
.export-block p{font-size:12px;color:var(--muted);margin-top:2px;}

/* B1 */
.dim-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.dim-item{background:#fff;border:1.5px solid var(--border);border-radius:10px;padding:14px 15px;transition:all .25s;}
.dim-name{font-size:13px;font-weight:600;color:var(--navy);margin-bottom:10px;}
.sem-btns{display:flex;gap:6px;}
.sem-btn{flex:1;border:none;border-radius:7px;padding:8px 4px;cursor:pointer;font-family:inherit;font-size:12px;font-weight:600;transition:all .18s;opacity:.5;}
.sem-btn:hover{opacity:.85;transform:translateY(-1px);}
.sem-btn.selected{opacity:1;transform:translateY(-1px);box-shadow:0 3px 10px rgba(0,0,0,.13);}
.sem-btn.g{background:var(--green-bg);color:var(--green);border:1.5px solid var(--green-bd);}
.sem-btn.y{background:var(--yellow-bg);color:var(--yellow);border:1.5px solid var(--yellow-bd);}
.sem-btn.r{background:var(--red-bg);color:var(--red);border:1.5px solid var(--red-bd);}
.sem-btn.g.selected{background:var(--green);color:#fff;border-color:var(--green);}
.sem-btn.y.selected{background:var(--yellow);color:#fff;border-color:var(--yellow);}
.sem-btn.r.selected{background:var(--red);color:#fff;border-color:var(--red);}
.tapete{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;}
.zone{border-radius:12px;padding:15px;min-height:140px;border:2px dashed;transition:all .3s;}
.zone.zg{background:var(--green-bg);border-color:var(--green-bd);}
.zone.zy{background:var(--yellow-bg);border-color:var(--yellow-bd);}
.zone.zr{background:var(--red-bg);border-color:var(--red-bd);}
.zone-hdr{font-size:13px;font-weight:700;margin-bottom:10px;text-align:center;}
.zone.zg .zone-hdr{color:var(--green);}
.zone.zy .zone-hdr{color:var(--yellow);}
.zone.zr .zone-hdr{color:var(--red);}
.chip{display:inline-block;font-size:12px;font-weight:600;padding:5px 10px;border-radius:6px;margin:3px;animation:chipIn .22s ease;}
@keyframes chipIn{from{transform:scale(.8);opacity:0;}to{transform:scale(1);opacity:1;}}
.zone.zg .chip{background:#dcfce7;color:var(--green);}
.zone.zy .chip{background:#fef9c3;color:var(--yellow);}
.zone.zr .chip{background:#fee2e2;color:var(--red);}
.hint{font-size:11px;color:#ccc;text-align:center;margin-top:14px;font-style:italic;}
.ev-row{display:none;align-items:flex-start;gap:8px;background:#fff;border:1px solid var(--border);border-radius:8px;padding:9px 12px;margin-bottom:7px;}
.ev-row.show{display:flex;}
.ev-label{font-size:12px;font-weight:600;min-width:130px;color:var(--muted);}
.ev-input{flex:1;border:none;outline:none;font-family:inherit;font-size:13px;color:var(--text);background:transparent;resize:none;}

/* B2 */
.cap-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
.cap-item{background:#fff;border:1.5px solid var(--border);border-radius:10px;padding:14px;transition:all .25s;}
.cap-code{font-size:11px;font-family:'DM Mono',monospace;color:var(--teal);margin-bottom:2px;}
.cap-name{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:10px;}
.lvl-btns{display:flex;gap:5px;margin-bottom:10px;}
.lvl-btn{flex:1;border:none;border-radius:6px;padding:6px 3px;cursor:pointer;font-family:inherit;font-size:11px;font-weight:600;transition:all .18s;opacity:.48;line-height:1.3;}
.lvl-btn:hover{opacity:.82;}
.lvl-btn.selected{opacity:1;box-shadow:0 2px 8px rgba(0,0,0,.13);transform:translateY(-1px);}
.lvl-btn.lg{background:var(--green-bg);color:var(--green);border:1.5px solid var(--green-bd);}
.lvl-btn.ly{background:var(--yellow-bg);color:var(--yellow);border:1.5px solid var(--yellow-bd);}
.lvl-btn.la{background:var(--amber-bg);color:var(--amber);border:1.5px solid var(--amber-bd);}
.lvl-btn.lr{background:var(--red-bg);color:var(--red);border:1.5px solid var(--red-bd);}
.lvl-btn.lg.selected{background:var(--green);color:#fff;border-color:var(--green);}
.lvl-btn.ly.selected{background:var(--yellow);color:#fff;border-color:var(--yellow);}
.lvl-btn.la.selected{background:var(--amber);color:#fff;border-color:var(--amber);}
.lvl-btn.lr.selected{background:var(--red);color:#fff;border-color:var(--red);}
.obs-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;}
.obs-input{width:100%;border:1.5px solid var(--border);border-radius:7px;padding:7px 10px;font-family:inherit;font-size:12px;color:var(--text);background:#fafafa;resize:none;outline:none;transition:border-color .2s;}
.obs-input:focus{border-color:var(--orange);background:#fff;}

/* Resumen B2 agrupado */
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.bar-label{font-size:12px;font-weight:600;min-width:160px;color:var(--navy);}
.bar-track{flex:1;height:10px;background:var(--border);border-radius:5px;overflow:hidden;}
.bar-fill{height:100%;border-radius:5px;transition:width .4s ease;}
.bar-num{font-size:11px;font-weight:700;min-width:36px;text-align:right;}
.nivel-group{border-radius:12px;overflow:hidden;margin-bottom:12px;border:1.5px solid;}
.nivel-group.ng{border-color:var(--green-bd);}
.nivel-group.ny{border-color:var(--yellow-bd);}
.nivel-group.na{border-color:var(--amber-bd);}
.nivel-group.nr{border-color:var(--red-bd);}
.nivel-hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;font-size:13px;font-weight:700;}
.nivel-group.ng .nivel-hdr{background:var(--green);color:#fff;}
.nivel-group.ny .nivel-hdr{background:var(--yellow);color:#fff;}
.nivel-group.na .nivel-hdr{background:var(--amber);color:#fff;}
.nivel-group.nr .nivel-hdr{background:var(--red);color:#fff;}
.nivel-count{font-size:12px;background:rgba(255,255,255,.25);padding:2px 8px;border-radius:10px;}
.nivel-cap-row{display:flex;align-items:flex-start;gap:12px;padding:10px 16px;border-bottom:1px solid rgba(0,0,0,.05);}
.nivel-cap-row:last-child{border-bottom:none;}
.nivel-cap-code{font-size:10px;font-family:'DM Mono',monospace;font-weight:700;min-width:44px;color:var(--muted);padding-top:2px;}
.nivel-cap-name{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:3px;}
.nivel-cap-obs{font-size:12px;color:var(--text);font-style:italic;background:rgba(0,0,0,.03);border-radius:5px;padding:4px 8px;border-left:3px solid;}
.nivel-group.ng .nivel-cap-obs{border-color:var(--green-bd);}
.nivel-group.ny .nivel-cap-obs{border-color:var(--yellow-bd);}
.nivel-group.na .nivel-cap-obs{border-color:var(--amber-bd);}
.nivel-group.nr .nivel-cap-obs{border-color:var(--red-bd);}
.no-obs{font-size:11px;color:#bbb;font-style:italic;}
.empty-nivel{padding:11px 16px;font-size:12px;color:var(--muted);font-style:italic;background:var(--bg);}

/* B3 */
.fsel,.finp{width:100%;border:1.5px solid var(--border);border-radius:8px;padding:8px 11px;font-family:inherit;font-size:13px;color:var(--text);background:#fafafa;outline:none;transition:border-color .2s,box-shadow .2s;appearance:none;}
.fsel:focus,.finp:focus{border-color:var(--purple);background:#fff;box-shadow:0 0 0 3px rgba(109,40,217,.09);}
.fg label{display:block;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:5px;}
/* Brecha card â€” flujo 4 pasos */
.brecha-card{background:#fff;border-radius:14px;overflow:hidden;border:1.5px solid var(--purple-bd);margin-bottom:16px;box-shadow:0 2px 10px rgba(109,40,217,.08);}
.brecha-hdr{background:var(--purple);padding:11px 18px;display:flex;align-items:center;gap:10px;}
.brecha-num{width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.25);color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.brecha-hdr-title{font-size:13px;font-weight:700;color:#fff;flex:1;}
.brecha-del{background:none;border:1px solid rgba(255,255,255,.3);border-radius:6px;padding:3px 10px;color:#fff;cursor:pointer;font-size:12px;font-family:inherit;}
.b3-steps{display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:1.5px solid var(--purple-bd);}
.b3-step{padding:16px 18px;border-right:1px solid var(--purple-bd);border-bottom:1px solid var(--purple-bd);}
.b3-step:nth-child(even){border-right:none;}
.b3-step:nth-child(3),.b3-step:nth-child(4){border-bottom:none;}
.step-tag{display:inline-flex;align-items:center;gap:6px;background:var(--purple);color:#fff;font-size:10px;font-weight:700;padding:3px 9px;border-radius:12px;margin-bottom:8px;letter-spacing:.04em;}
.step-q{font-size:11px;color:var(--muted);margin-bottom:8px;font-style:italic;line-height:1.5;}
.obs-pills{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px;min-height:28px;padding:6px 8px;background:#fafafa;border:1.5px solid var(--border);border-radius:8px;}
.obs-pill{background:var(--purple-bg);border:1px solid var(--purple-bd);color:var(--purple);font-size:11px;font-weight:600;padding:3px 8px;border-radius:10px;display:flex;align-items:center;gap:4px;animation:chipIn .18s ease;}
.obs-pill button{background:none;border:none;cursor:pointer;color:var(--purple);font-size:12px;padding:0;line-height:1;}
.obs-add-row{display:flex;gap:6px;margin-top:4px;}
.obs-add-inp{flex:1;border:1.5px solid var(--border);border-radius:7px;padding:6px 10px;font-family:inherit;font-size:12px;outline:none;transition:border-color .2s;}
.obs-add-inp:focus{border-color:var(--purple);}
.obs-add-btn{background:var(--purple);color:#fff;border:none;border-radius:7px;padding:6px 12px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;}
.cap-inst-list{display:flex;flex-direction:column;gap:5px;margin-bottom:8px;}
.cap-inst-row{display:flex;gap:6px;align-items:center;}
.cap-inst-inp{flex:1;border:1.5px solid var(--border);border-radius:7px;padding:6px 10px;font-family:inherit;font-size:12px;outline:none;transition:border-color .2s;}
.cap-inst-inp:focus{border-color:var(--purple);}
.cap-inst-del{background:none;border:none;cursor:pointer;color:var(--muted);font-size:16px;padding:0 2px;}
.cap-add-btn{background:none;border:1.5px dashed var(--purple-bd);border-radius:7px;padding:5px 12px;font-family:inherit;font-size:11px;font-weight:600;color:var(--purple);cursor:pointer;transition:all .18s;}
.cap-add-btn:hover{background:var(--purple-bg);}
/* Preview brecha */
.b-preview-full{grid-column:1/-1;padding:16px 18px;background:var(--purple-bg);border-top:1.5px solid var(--purple-bd);}
.b-preview-lbl{font-size:10px;font-weight:700;color:var(--purple);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;}
.b-preview-txt{font-size:13.5px;color:var(--navy);line-height:1.7;font-style:italic;}
.b-preview-txt .fill{color:var(--purple);font-weight:700;font-style:normal;background:rgba(109,40,217,.1);padding:1px 5px;border-radius:4px;}
.b-preview-txt .blank{color:#bbb;}
.add-brecha-btn{width:100%;padding:12px;border:2px dashed var(--purple-bd);border-radius:12px;background:none;cursor:pointer;font-family:inherit;font-size:13px;font-weight:600;color:var(--purple);transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px;}
.add-brecha-btn:hover{background:var(--purple-bg);border-style:solid;}
/* Resumen obstÃ¡culos del B2 */
.obs-resumen{background:#fff;border:1.5px solid var(--purple-bd);border-radius:12px;padding:16px 18px;margin-bottom:18px;}
.obs-resumen-title{font-size:11px;font-weight:700;color:var(--purple);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;}
.obs-resumen-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px;}
.obs-dim-chip{background:var(--purple-bg);border:1px solid var(--purple-bd);border-radius:8px;padding:7px 11px;}
.obs-dim-name{font-size:10px;font-weight:700;color:var(--purple);margin-bottom:4px;}
.obs-dim-val{font-size:12px;color:var(--navy);font-style:italic;}

/* B4 */
.relato-brecha-box{background:var(--card);border-radius:10px;padding:13px 17px;border:1px solid var(--border);margin-bottom:16px;display:flex;gap:18px;align-items:center;flex-wrap:wrap;}
.relato-brecha-box label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;display:block;margin-bottom:5px;}
.momento-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
.momento-card{background:#fff;border-radius:11px;overflow:hidden;border:1.5px solid var(--green-bd);}
.m-hdr{background:var(--green);padding:9px 13px;display:flex;align-items:center;gap:8px;}
.m-icon{font-size:17px;}
.m-title{font-size:12px;font-weight:700;color:#fff;}
.m-body{padding:13px;}
.m-q{font-size:11.5px;color:var(--muted);margin-bottom:9px;font-style:italic;line-height:1.5;}
.m-input{width:100%;border:1.5px solid var(--border);border-radius:7px;padding:7px 10px;font-family:inherit;font-size:13px;font-weight:600;color:var(--navy);background:var(--green-bg);outline:none;transition:all .2s;}
.m-input:focus{border-color:var(--green);background:#fff;}
.m-chip{font-size:11px;font-weight:700;margin-top:8px;padding:5px 9px;border-radius:6px;text-align:center;}
.m-chip.asig{background:var(--green);color:#fff;}
.m-chip.vacio{background:var(--green-bg);color:var(--muted);border:1px dashed var(--green-bd);}
.relato-area{background:#fff;border:1.5px solid var(--green-bd);border-radius:11px;padding:15px;margin-top:16px;}
.relato-area h3{font-size:13px;font-weight:700;color:var(--green);margin-bottom:10px;}
.relato-textarea{width:100%;border:1.5px solid var(--border);border-radius:8px;padding:10px 13px;font-family:inherit;font-size:13px;line-height:1.7;color:var(--text);background:var(--green-bg);outline:none;resize:vertical;min-height:90px;transition:border-color .2s;}
.relato-textarea:focus{border-color:var(--green);background:#fff;}

/* MODAL PLENARIA */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:800;display:none;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;}
.modal-overlay.open{display:flex;}
.modal-box{background:#fff;border-radius:18px;width:100%;max-width:980px;box-shadow:0 24px 60px rgba(0,0,0,.3);animation:slideUp .3s ease;margin:auto;}
@keyframes slideUp{from{transform:translateY(28px);opacity:0;}to{transform:none;opacity:1;}}
.modal-nav{background:var(--navy);border-radius:18px 18px 0 0;padding:14px 22px;display:flex;align-items:center;justify-content:space-between;}
.modal-nav h2{font-size:15px;font-weight:700;color:#fff;}
.modal-close{background:none;border:1px solid rgba(255,255,255,.3);border-radius:8px;padding:6px 14px;color:#fff;cursor:pointer;font-family:inherit;font-size:12px;font-weight:600;transition:background .2s;}
.modal-close:hover{background:rgba(255,255,255,.15);}
.modal-body{padding:24px;}
.modal-sec{margin-bottom:26px;}
.modal-sec-title{font-size:12px;font-weight:700;color:var(--navy);text-transform:uppercase;letter-spacing:.07em;margin-bottom:13px;padding-bottom:6px;border-bottom:2px solid var(--border);}
.pl-tapete{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;}
.pl-zone{border-radius:12px;padding:14px;border:2px solid;}
.pl-zone.plg{background:var(--green-bg);border-color:var(--green-bd);}
.pl-zone.ply{background:var(--yellow-bg);border-color:var(--yellow-bd);}
.pl-zone.plr{background:var(--red-bg);border-color:var(--red-bd);}
.pl-zone-hdr{font-size:13px;font-weight:700;margin-bottom:10px;text-align:center;padding-bottom:7px;border-bottom:1.5px solid;}
.pl-zone.plg .pl-zone-hdr{color:var(--green);border-color:var(--green-bd);}
.pl-zone.ply .pl-zone-hdr{color:var(--yellow);border-color:var(--yellow-bd);}
.pl-zone.plr .pl-zone-hdr{color:var(--red);border-color:var(--red-bd);}
.pl-dim-item{background:#fff;border-radius:8px;padding:8px 10px;margin-bottom:5px;border:1px solid rgba(0,0,0,.06);}
.pl-dim-name{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:2px;}
.pl-dim-ev{font-size:11px;color:var(--muted);font-style:italic;}
/* GalerÃ­a plenaria â€” agrupada por nivel */
.pl-nivel-group{border-radius:11px;overflow:hidden;margin-bottom:11px;border:1.5px solid;}
.pl-nivel-group.ng{border-color:var(--green-bd);}
.pl-nivel-group.ny{border-color:var(--yellow-bd);}
.pl-nivel-group.na{border-color:var(--amber-bd);}
.pl-nivel-group.nr{border-color:var(--red-bd);}
.pl-nivel-hdr{display:flex;align-items:center;justify-content:space-between;padding:9px 15px;font-size:13px;font-weight:700;}
.pl-nivel-group.ng .pl-nivel-hdr{background:var(--green);color:#fff;}
.pl-nivel-group.ny .pl-nivel-hdr{background:var(--yellow);color:#fff;}
.pl-nivel-group.na .pl-nivel-hdr{background:var(--amber);color:#fff;}
.pl-nivel-group.nr .pl-nivel-hdr{background:var(--red);color:#fff;}
.pl-nivel-cnt{font-size:11px;background:rgba(255,255,255,.25);padding:2px 8px;border-radius:10px;}
.pl-cap-row{display:flex;align-items:flex-start;gap:10px;padding:9px 15px;border-bottom:1px solid rgba(0,0,0,.05);}
.pl-cap-row:last-child{border-bottom:none;}
.pl-cap-code{font-size:10px;font-family:'DM Mono',monospace;font-weight:700;min-width:40px;color:var(--muted);padding-top:2px;}
.pl-cap-name{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:3px;}
.pl-cap-obs{font-size:11.5px;color:var(--text);font-style:italic;padding:3px 8px;border-radius:4px;border-left:3px solid;background:rgba(0,0,0,.03);}
.pl-nivel-group.ng .pl-cap-obs{border-color:var(--green-bd);}
.pl-nivel-group.ny .pl-cap-obs{border-color:var(--yellow-bd);}
.pl-nivel-group.na .pl-cap-obs{border-color:var(--amber-bd);}
.pl-nivel-group.nr .pl-cap-obs{border-color:var(--red-bd);}
.pl-no-obs{font-size:11px;color:#bbb;font-style:italic;}
.pl-brecha{background:var(--purple-bg);border:1.5px solid var(--purple-bd);border-radius:10px;padding:12px 14px;margin-bottom:9px;}
.pl-brecha-num{font-size:10px;font-weight:700;color:var(--purple);text-transform:uppercase;margin-bottom:5px;}
.pl-brecha-txt{font-size:13px;color:var(--navy);font-style:italic;line-height:1.6;}
.pl-brecha-txt .fill{font-weight:700;font-style:normal;color:var(--purple);}
.toast{position:fixed;bottom:22px;right:22px;z-index:999;background:var(--navy);color:#fff;padding:11px 18px;border-radius:10px;font-size:13px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,.22);transform:translateY(80px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
@media(max-width:760px){
  .tapete,.pl-tapete,.momento-grid,.bf-grid{grid-template-columns:1fr;}
  .dim-grid,.cap-grid{grid-template-columns:1fr;}
  .export-block{flex-direction:column;}
}
</style>
</head>
<body>

<nav>
  <div class="nav-brand">PETI <span>2027</span><span class="nav-sub">Grupo Virtual Â· Facilitadora</span></div>
  <div class="nav-tabs">
    <button class="tab-btn active" onclick="showTab(0)"><span class="tab-num">1</span>DiagnÃ³stico</button>
    <button class="tab-btn" onclick="showTab(1)"><span class="tab-num">2</span>Capacidades</button>
    <button class="tab-btn" onclick="showTab(2)"><span class="tab-num">3</span>Brechas</button>
    <button class="tab-btn" onclick="showTab(3)"><span class="tab-num">4</span>Relato</button>
  </div>
  <div class="nav-right">
    <button class="plenaria-btn" onclick="abrirPlenaria()">ðŸ“Š Vista Plenaria</button>
  </div>
</nav>

<main>

<!-- B1 -->
<div class="page active" id="page-0">
  <div class="page-header" style="border-left-color:var(--teal)">
    <div>
      <h1>Bloque 1 Â· DiagnÃ³stico del PETI</h1>
      <p>El grupo discute y consensÃºa un color por dimensiÃ³n. Registre el resultado aquÃ­.</p>
      <div class="progress-bar"><div class="progress-fill" id="prog1" style="width:0%;background:var(--teal)"></div></div>
    </div>
    <div class="btn-row">
      <button class="reset-btn" onclick="resetB1()">â†º Reiniciar</button>
      <span class="badge" style="background:var(--teal)">6 dimensiones</span>
    </div>
  </div>
  <div class="dim-grid" id="dim-grid"></div>
  <div class="card">
    <div class="card-title">Tapete del grupo virtual</div>
    <div class="tapete">
      <div class="zone zg"><div class="zone-hdr">ðŸŸ¢ DesempeÃ±o Adecuado</div><div id="zone-g"><div class="hint">Ninguna aÃºn</div></div></div>
      <div class="zone zy"><div class="zone-hdr">ðŸŸ¡ Parcial / En Riesgo</div><div id="zone-y"><div class="hint">Ninguna aÃºn</div></div></div>
      <div class="zone zr"><div class="zone-hdr">ðŸ”´ CrÃ­tico</div><div id="zone-r"><div class="hint">Ninguna aÃºn</div></div></div>
    </div>
  </div>
  <div class="card" style="margin-top:15px">
    <div class="card-title">Evidencias (dimensiones en amarillo o rojo)</div>
    <div id="ev-area"></div>
    <div id="ev-hint" style="font-size:13px;color:var(--muted);font-style:italic">AparecerÃ¡n aquÃ­ al marcar una dimensiÃ³n en amarillo o rojo.</div>
  </div>
  <div class="export-block">
    <div><strong>Exportar Bloque 1</strong><p>Tapete y evidencias del grupo virtual en .txt</p></div>
    <button class="export-btn" onclick="exportar(1)">â¬‡ Exportar Bloque 1</button>
  </div>
</div>

<!-- B2 -->
<div class="page" id="page-1">
  <div class="page-header" style="border-left-color:var(--orange)">
    <div>
      <h1>Bloque 2 Â· GalerÃ­a de Capacidades</h1>
      <p>Registre el nivel consensuado y el obstÃ¡culo principal de cada capacidad.</p>
      <div class="progress-bar"><div class="progress-fill" id="prog2" style="width:0%;background:var(--orange)"></div></div>
    </div>
    <div class="btn-row">
      <button class="reset-btn" onclick="resetB2()">â†º Reiniciar</button>
      <span class="badge" style="background:var(--orange)">19 capacidades</span>
    </div>
  </div>
  <div class="cap-grid" id="cap-grid"></div>
  <div class="card" style="margin-top:15px">
    <div class="card-title">Resumen agrupado por nivel Â· con obstÃ¡culos</div>
    <div id="resumen-bars" style="margin-bottom:16px"></div>
    <div id="resumen-grupos"></div>
  </div>
  <div class="export-block">
    <div><strong>Exportar Bloque 2</strong><p>Capacidades agrupadas por nivel con obstÃ¡culos</p></div>
    <button class="export-btn" onclick="exportar(2)">â¬‡ Exportar Bloque 2</button>
  </div>
</div>

<!-- B3 -->
<div class="page" id="page-2">
  <div class="page-header" style="border-left-color:var(--purple)">
    <div>
      <h1>Bloque 3 Â· FormulaciÃ³n de Brechas</h1>
      <p>A partir de las capacidades dÃ©biles y obstÃ¡culos del Bloque 2, formule brechas estratÃ©gicas en 4 pasos.</p>
    </div>
    <span class="badge" style="background:var(--purple)">4 pasos</span>
  </div>

  <!-- Resumen obstÃ¡culos del B2 -->
  <div class="obs-resumen">
    <div class="obs-resumen-title">ObstÃ¡culos registrados en Bloque 2 â€” use estos como insumo</div>
    <div class="obs-resumen-grid" id="obs-resumen-grid">
      <div style="font-size:12px;color:var(--muted);font-style:italic">Cuando registre obstÃ¡culos en el Bloque 2 aparecerÃ¡n aquÃ­ automÃ¡ticamente.</div>
    </div>
  </div>

  <div id="brechas-cont"></div>
  <button class="add-brecha-btn" onclick="addBrecha()">ï¼‹ Agregar brecha</button>
  <div class="export-block" style="margin-top:16px">
    <div><strong>Exportar Bloque 3</strong><p>Brechas formuladas listas para consolidar en plenaria</p></div>
    <button class="export-btn" onclick="exportar(3)">â¬‡ Exportar Bloque 3</button>
  </div>
</div>

<!-- B4 -->
<div class="page" id="page-3">
  <div class="page-header" style="border-left-color:var(--green)">
    <div>
      <h1>Bloque 4 Â· Relato EstratÃ©gico</h1>
      <p>Asigne los 6 momentos y construya el relato en vivo.</p>
    </div>
    <span class="badge" style="background:var(--green)">6 momentos</span>
  </div>
  <div class="relato-brecha-box">
    <div>
      <label>Brecha que trabaja este relato</label>
      <select class="fsel" id="brecha-sel" onchange="actualizarBrecha()" style="min-width:200px">
        <option value="">â€” seleccionar â€”</option>
      </select>
    </div>
    <div style="flex:1">
      <label>Brecha seleccionada</label>
      <div id="brecha-txt" style="font-size:13px;color:var(--muted);font-style:italic">Seleccione una brecha del Bloque 3</div>
    </div>
  </div>
  <div class="momento-grid" id="momento-grid"></div>
  <div class="relato-area">
    <h3>ðŸ“– Relato construido en vivo</h3>
    <textarea class="relato-textarea" id="relato-txt"
      placeholder="A medida que cada participante narra su momento, escriba aquÃ­ el relato del grupo..."
      oninput="debouncedSave()"></textarea>
  </div>
  <div class="export-block">
    <div><strong>Exportar resumen completo</strong><p>Todos los bloques del grupo virtual en un archivo</p></div>
    <button class="export-btn" onclick="exportar(4)">â¬‡ Exportar resumen completo</button>
  </div>
</div>

</main>

<!-- MODAL PLENARIA -->
<div class="modal-overlay" id="modal-plenaria">
  <div class="modal-box">
    <div class="modal-nav">
      <h2>ðŸ“Š Vista Plenaria â€” Resultado Grupo Virtual</h2>
      <button class="modal-close" onclick="cerrarPlenaria()">âœ• Cerrar</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<div class="save-pill" id="save-pill"><div class="save-dot"></div>Guardado</div>
<div class="toast" id="toast"></div>

<script>
const DIMS=[
  {id:"alin",name:"AlineaciÃ³n EstratÃ©gica",short:"AlineaciÃ³n"},
  {id:"ejec",name:"Cumplimiento y EjecuciÃ³n",short:"Cumplimiento"},
  {id:"gob", name:"Gobierno y GestiÃ³n",       short:"Gobierno"},
  {id:"arq", name:"Arquitectura y Cap. TI",   short:"Arquitectura"},
  {id:"info",name:"GestiÃ³n de InformaciÃ³n",   short:"InformaciÃ³n"},
  {id:"tal", name:"Talento y Cap. Operativa", short:"Talento"},
];
const CAPS=[
  {id:"cap01",name:"Gestionar la Estrategia Institucional"},
  {id:"cap02",name:"Gestionar Proyectos de InversiÃ³n"},
  {id:"cap03",name:"Gestionar el Conocimiento del Recurso Natural"},
  {id:"cap04",name:"Promocionar y Fomentar ExploraciÃ³n y ExplotaciÃ³n del Recurso Natural"},
  {id:"cap05",name:"Gestionar UpStream (E&P - GeneraciÃ³n)"},
  {id:"cap06",name:"Gestionar el control de operaciones y fiscalizaciÃ³n"},
  {id:"cap07",name:"AnÃ¡lisis de InformaciÃ³n de producciÃ³n y reservas de hidrocarburos"},
  {id:"cap08",name:"Gestionar RegalÃ­as y Derechos EconÃ³micos"},
  {id:"cap09",name:"Implementar el Desarrollo Sostenible"},
  {id:"cap10",name:"Gestionar el Talento Humano"},
  {id:"cap11",name:"ParticipaciÃ³n Ciudadana en la GestiÃ³n PÃºblica"},
  {id:"cap12",name:"GestiÃ³n Presupuestal y Eficiencia del Gasto PÃºblico"},
  {id:"cap13",name:"Gobierno y GestiÃ³n de TI"},
  {id:"cap14",name:"Gestionar la defensa legal"},
  {id:"cap15",name:"Gestionar Contratos y Convenios"},
  {id:"cap16",name:"Gestionar Recursos Institucionales"},
  {id:"cap17",name:"GestiÃ³n Documental"},
  {id:"cap18",name:"Administrar Sistemas Integrados de GestiÃ³n"},
  {id:"cap19",name:"Gestionar la mejora continua"},
];
const MOMENTOS=[
  {n:"1",icon:"âš¡",title:"Punto de Quiebre",    q:"Â¿QuÃ© situaciÃ³n crÃ­tica evidenciÃ³ que la brecha ya no podÃ­a continuar?"},
  {n:"2",icon:"ðŸŽ¯",title:"DecisiÃ³n EstratÃ©gica", q:"Â¿QuÃ© decisiÃ³n estructural tomÃ³ la OTI para cerrar la brecha?"},
  {n:"3",icon:"ðŸ§±",title:"Resistencia",          q:"Â¿QuÃ© resistencia institucional apareciÃ³ y cÃ³mo fue gestionada?"},
  {n:"4",icon:"ðŸ’¡",title:"Apuesta Estructural",  q:"Â¿En quÃ© se invirtiÃ³ para que el cambio fuera sostenible?"},
  {n:"5",icon:"ðŸ”„",title:"Cambio Implementado",  q:"Â¿QuÃ© cambiÃ³ permanentemente en la forma de trabajar?"},
  {n:"6",icon:"ðŸ†",title:"Resultado Logrado",    q:"Â¿QuÃ© mejora concreta se evidenciÃ³ en la capacidad impactada?"},
];
const DIM_OPTS=["â€” seleccionar â€”",...DIMS.map(d=>d.name)];
const CAP_OPTS=["â€” seleccionar â€”",...CAPS.map(c=>c.name)];
const NLVL={
  green:{icon:"ðŸŸ¢",label:"Consolidada",bg:"var(--green-bg)",bd:"var(--green-bd)",tc:"var(--green)",cls:"ng"},
  yellow:{icon:"ðŸŸ¡",label:"Funcional",bg:"var(--yellow-bg)",bd:"var(--yellow-bd)",tc:"var(--yellow)",cls:"ny"},
  amber:{icon:"ðŸŸ ",label:"FrÃ¡gil",bg:"var(--amber-bg)",bd:"var(--amber-bd)",tc:"var(--amber)",cls:"na"},
  red:{icon:"ðŸ”´",label:"Declarativa",bg:"var(--red-bg)",bd:"var(--red-bd)",tc:"var(--red)",cls:"nr"},
};
const SLV={green:"ðŸŸ¢ Adecuado",yellow:"ðŸŸ¡ Parcial",red:"ðŸ”´ CrÃ­tico"};
const SK='peti2027_vf2';
let state={semaforo:{},evidencias:{},capacidades:{},obstaculos:{},brechas:[],brechaCount:0,momentos:{},relatoTxt:''};

function persist(){
  try{
    state.brechas.forEach(b=>{
      const causa=document.getElementById(`b${b.id}-causa`);if(causa)b.causa=causa.value;
      const dim=document.getElementById(`b${b.id}-dim`);if(dim)b.dim=dim.value;
      const red=document.getElementById(`b${b.id}-redaccion`);if(red)b.redaccion=red.value;
      syncCaps(b.id);
    });
    DIMS.forEach(d=>{const e=document.getElementById(`ev-${d.id}`);if(e)state.evidencias[d.id]=e.value;});
    CAPS.forEach(c=>{const e=document.getElementById(`obs-${c.id}`);if(e)state.obstaculos[c.id]=e.value;});
    state.relatoTxt=document.getElementById('relato-txt')?.value||'';
    localStorage.setItem(SK,JSON.stringify(state));
    flash();
  }catch(e){}
}
function load(){try{const r=localStorage.getItem(SK);if(r)state={...state,...JSON.parse(r)};}catch(e){}}
let st;function debouncedSave(){clearTimeout(st);st=setTimeout(persist,700);}
function flash(){const el=document.getElementById('save-pill');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),1800);}

function showTab(i){
  document.querySelectorAll('.page').forEach((p,j)=>p.classList.toggle('active',j===i));
  document.querySelectorAll('.tab-btn').forEach((b,j)=>b.classList.toggle('active',j===i));
  if(i===2)obsResumen();
  if(i===3)refrescarBrechaSel();
}

// â”€â”€ B1 â”€â”€
function initB1(){
  document.getElementById('dim-grid').innerHTML=DIMS.map(d=>`
    <div class="dim-item" id="dim-${d.id}">
      <div class="dim-name">${d.name}</div>
      <div class="sem-btns">
        <button class="sem-btn g" onclick="setSem('${d.id}','green')">ðŸŸ¢ Adecuado</button>
        <button class="sem-btn y" onclick="setSem('${d.id}','yellow')">ðŸŸ¡ Parcial</button>
        <button class="sem-btn r" onclick="setSem('${d.id}','red')">ðŸ”´ CrÃ­tico</button>
      </div>
    </div>`).join('');
  document.getElementById('ev-area').innerHTML=DIMS.map(d=>`
    <div class="ev-row" id="ev-row-${d.id}">
      <span class="ev-label">${d.short}</span>
      <textarea class="ev-input" id="ev-${d.id}" rows="1" placeholder="Evidencia del grupo..."
        oninput="state.evidencias['${d.id}']=this.value;debouncedSave()"></textarea>
    </div>`).join('');
}
function restoreB1(){
  Object.entries(state.semaforo).forEach(([id,lv])=>applyDim(id,lv));
  DIMS.forEach(d=>{
    const el=document.getElementById(`ev-${d.id}`);if(el&&state.evidencias[d.id])el.value=state.evidencias[d.id];
    const lv=state.semaforo[d.id];
    if(lv==='yellow'||lv==='red')document.getElementById(`ev-row-${d.id}`)?.classList.add('show');
  });
  hintEv();updateTapete();
  document.getElementById('prog1').style.width=`${Object.keys(state.semaforo).length/6*100}%`;
}
function setSem(id,lv){
  state.semaforo[id]=lv;applyDim(id,lv);
  DIMS.forEach(d=>{
    const dlv=state.semaforo[d.id];
    const row=document.getElementById(`ev-row-${d.id}`);
    if(row)(dlv==='yellow'||dlv==='red')?row.classList.add('show'):row.classList.remove('show');
  });
  hintEv();updateTapete();
  document.getElementById('prog1').style.width=`${Object.keys(state.semaforo).length/6*100}%`;
  debouncedSave();
}
function hintEv(){
  const hay=DIMS.some(d=>state.semaforo[d.id]==='yellow'||state.semaforo[d.id]==='red');
  document.getElementById('ev-hint').style.display=hay?'none':'block';
}
function applyDim(id,lv){
  const el=document.getElementById(`dim-${id}`);if(!el)return;
  el.querySelectorAll('.sem-btn').forEach(b=>b.classList.remove('selected'));
  el.querySelector(`.sem-btn.${lv[0]}`)?.classList.add('selected');
  const bgs={green:'var(--green-bg)',yellow:'var(--yellow-bg)',red:'var(--red-bg)'};
  const bds={green:'var(--green-bd)',yellow:'var(--yellow-bd)',red:'var(--red-bd)'};
  el.style.background=bgs[lv];el.style.borderColor=bds[lv];
}
function updateTapete(){
  ['green','yellow','red'].forEach(lv=>{
    const zone=document.getElementById(`zone-${lv[0]}`);
    const dims=DIMS.filter(d=>state.semaforo[d.id]===lv);
    zone.innerHTML=dims.length?dims.map(d=>`<span class="chip">${d.short}</span>`).join(''):'<div class="hint">Ninguna aÃºn</div>';
  });
}
function resetB1(){state.semaforo={};state.evidencias={};initB1();updateTapete();document.getElementById('prog1').style.width='0%';hintEv();persist();showToast('Bloque 1 reiniciado');}

// â”€â”€ B2 â”€â”€
function initB2(){
  document.getElementById('cap-grid').innerHTML=CAPS.map((c,i)=>`
    <div class="cap-item" id="cap-${c.id}">
      <div class="cap-code">${String(i+1).padStart(2,'0')}</div>
      <div class="cap-name">${c.name}</div>
      <div class="lvl-btns">
        <button class="lvl-btn lg" onclick="setCap('${c.id}','green')">ðŸŸ¢ Consolidada</button>
        <button class="lvl-btn ly" onclick="setCap('${c.id}','yellow')">ðŸŸ¡ Funcional</button>
        <button class="lvl-btn la" onclick="setCap('${c.id}','amber')">ðŸŸ  FrÃ¡gil</button>
        <button class="lvl-btn lr" onclick="setCap('${c.id}','red')">ðŸ”´ Declarativa</button>
      </div>
      <div class="obs-lbl">ObstÃ¡culo principal</div>
      <textarea class="obs-input" id="obs-${c.id}" rows="2"
        placeholder="Â¿QuÃ© impide que esta capacidad sea mÃ¡s sÃ³lida?"
        oninput="state.obstaculos['${c.id}']=this.value;debouncedSave();updateResumen()"></textarea>
    </div>`).join('');
}
function restoreB2(){
  Object.entries(state.capacidades).forEach(([id,lv])=>applyCapStyle(id,lv));
  CAPS.forEach(c=>{const el=document.getElementById(`obs-${c.id}`);if(el&&state.obstaculos[c.id])el.value=state.obstaculos[c.id];});
  document.getElementById('prog2').style.width=`${Object.keys(state.capacidades).length/12*100}%`;
  updateResumen();
}
function setCap(id,lv){
  state.capacidades[id]=lv;applyCapStyle(id,lv);
  document.getElementById('prog2').style.width=`${Object.keys(state.capacidades).length/12*100}%`;
  updateResumen();debouncedSave();
}
function applyCapStyle(id,lv){
  const el=document.getElementById(`cap-${id}`);if(!el)return;
  el.querySelectorAll('.lvl-btn').forEach(b=>b.classList.remove('selected'));
  const map={green:'lg',yellow:'ly',amber:'la',red:'lr'};
  el.querySelector(`.lvl-btn.${map[lv]}`)?.classList.add('selected');
  const n=NLVL[lv];el.style.background=n.bg;el.style.borderColor=n.bd;
}
function updateResumen(){
  const total=Object.keys(state.capacidades).length;
  const cnt={green:0,yellow:0,amber:0,red:0};
  Object.values(state.capacidades).forEach(v=>cnt[v]++);
  // barras
  document.getElementById('resumen-bars').innerHTML=
    [{k:'green',l:'ðŸŸ¢ Consolidadas',c:'var(--green)'},
     {k:'yellow',l:'ðŸŸ¡ Funcionales',c:'var(--yellow)'},
     {k:'amber',l:'ðŸŸ  FrÃ¡giles',c:'var(--amber)'},
     {k:'red',l:'ðŸ”´ Declarativas',c:'var(--red)'}]
    .map(x=>`<div class="bar-row">
      <span class="bar-label">${x.l}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${total?cnt[x.k]/12*100:0}%;background:${x.c}"></div></div>
      <span class="bar-num" style="color:${x.c}">${cnt[x.k]}/12</span>
    </div>`).join('');
  if(!total){document.getElementById('resumen-grupos').innerHTML='<p style="color:var(--muted);font-size:13px;font-style:italic">El resumen aparecerÃ¡ aquÃ­ a medida que califique las capacidades.</p>';return;}
  // grupos
  document.getElementById('resumen-grupos').innerHTML=
    [{lv:'green',label:'ðŸŸ¢ Consolidadas'},{lv:'yellow',label:'ðŸŸ¡ Funcionales'},
     {lv:'amber',label:'ðŸŸ  FrÃ¡giles'},{lv:'red',label:'ðŸ”´ Declarativas'}]
    .map(g=>{
      const n=NLVL[g.lv];
      const caps=CAPS.filter(c=>state.capacidades[c.id]===g.lv);
      const rows=caps.length
        ?caps.map(c=>{
            const obs=state.obstaculos[c.id]||'';
            return `<div class="nivel-cap-row">
              <div style="flex:1">
                <div class="nivel-cap-name">${c.name}</div>
                ${obs?`<div class="nivel-cap-obs nivel-group ${n.cls}">âš  ${obs}</div>`:`<span class="no-obs">Sin obstÃ¡culo registrado</span>`}
              </div>
            </div>`;
          }).join('')
        :`<div class="empty-nivel">Ninguna capacidad en este nivel</div>`;
      return `<div class="nivel-group ${n.cls}">
        <div class="nivel-hdr"><span>${g.label}</span><span class="nivel-count">${caps.length} capacidad${caps.length!==1?'es':''}</span></div>
        ${rows}
      </div>`;
    }).join('');
}
function resetB2(){state.capacidades={};state.obstaculos={};initB2();document.getElementById('prog2').style.width='0%';updateResumen();persist();showToast('Bloque 2 reiniciado');}

// â”€â”€ B3 â”€â”€
const CAP_INST=[
  'Gestionar la Estrategia Institucional',
  'Gestionar Proyectos de InversiÃ³n',
  'Gestionar el Conocimiento del Recurso Natural',
  'Promocionar y Fomentar ExploraciÃ³n y ExplotaciÃ³n del Recurso Natural',
  'Gestionar UpStream (E&P - GeneraciÃ³n)',
  'Gestionar el control de operaciones y fiscalizaciÃ³n',
  'AnÃ¡lisis de InformaciÃ³n de producciÃ³n y reservas de hidrocarburos',
  'Gestionar RegalÃ­as y Derechos EconÃ³micos',
  'Implementar el Desarrollo Sostenible',
  'Gestionar el Talento Humano',
  'ParticipaciÃ³n Ciudadana en la GestiÃ³n PÃºblica',
  'GestiÃ³n Presupuestal y Eficiencia del Gasto PÃºblico',
  'Gobierno y GestiÃ³n de TI',
  'Gestionar la defensa legal',
  'Gestionar Contratos y Convenios',
  'Gestionar Recursos Institucionales',
  'GestiÃ³n Documental',
  'Administrar Sistemas Integrados de GestiÃ³n',
  'Gestionar la mejora continua',
];
const DIM_CAPS={
  'AlineaciÃ³n EstratÃ©gica':CAP_INST,
  'Cumplimiento y EjecuciÃ³n':CAP_INST,
  'Gobierno y GestiÃ³n':CAP_INST,
  'Arquitectura y Cap. TI':CAP_INST,
  'GestiÃ³n de InformaciÃ³n':CAP_INST,
  'Talento y Cap. Operativa':CAP_INST,
};

function obsResumen(){
  const grid=document.getElementById('obs-resumen-grid');if(!grid)return;
  const items=CAPS.map(c=>({name:c.name,obs:state.obstaculos[c.id]||''})).filter(x=>x.obs.trim());
  if(!items.length){grid.innerHTML='<div style="font-size:12px;color:var(--muted);font-style:italic">Cuando registre obstÃ¡culos en el Bloque 2 aparecerÃ¡n aquÃ­ automÃ¡ticamente.</div>';return;}
  grid.innerHTML=items.map(x=>`<div class="obs-dim-chip"><div class="obs-dim-name">${x.name}</div><div class="obs-dim-val">"${x.obs}"</div></div>`).join('');
}

function addBrecha(restored){
  state.brechaCount++;
  const id=state.brechaCount;
  const div=document.createElement('div');
  div.className='brecha-card';div.id=`brecha-${id}`;
  const dimOpts=Object.keys(DIM_CAPS).map(d=>`<option value="${d}">${d}</option>`).join('');
  div.innerHTML=`
    <div class="brecha-hdr">
      <div class="brecha-num">${id}</div>
      <div class="brecha-hdr-title">Brecha ${id}</div>
      <button class="brecha-del" onclick="removeBrecha(${id})">âœ• Eliminar</button>
    </div>
    <div class="b3-steps">
      <!-- PASO 1 -->
      <div class="b3-step">
        <div class="step-tag">Paso 1 Â· Agrupar obstÃ¡culos</div>
        <div class="step-q">Tome los obstÃ¡culos del Bloque 2. Â¿CuÃ¡les corresponden a la misma dimensiÃ³n? AgrÃ©guelos aquÃ­.</div>
        <div class="obs-pills" id="pills-${id}"></div>
        <div class="obs-add-row">
          <input class="obs-add-inp" id="obs-inp-${id}" placeholder="Escribir obstÃ¡culo y Enter..." onkeydown="if(event.key==='Enter'){addPill(${id});event.preventDefault();}">
          <button class="obs-add-btn" onclick="addPill(${id})">+ Agregar</button>
        </div>
      </div>
      <!-- PASO 2 -->
      <div class="b3-step">
        <div class="step-tag">Paso 2 Â· Causa estructural</div>
        <div class="step-q">Â¿QuÃ© factor estructural explica todos esos obstÃ¡culos juntos? No el sÃ­ntoma â€” la raÃ­z.</div>
        <div class="fg"><label>Causa estructural</label>
          <textarea class="obs-add-inp" id="b${id}-causa" rows="3" style="width:100%;resize:none"
            placeholder="Ej: FragmentaciÃ³n tecnolÃ³gica y falta de interoperabilidad entre sistemas..."
            oninput="previewB(${id});debouncedSave()"></textarea></div>
      </div>
      <!-- PASO 3 -->
      <div class="b3-step">
        <div class="step-tag">Paso 3 Â· DimensiÃ³n y capacidades afectadas</div>
        <div class="step-q">Seleccione la dimensiÃ³n del PETI y las capacidades institucionales que estÃ¡n siendo impactadas.</div>
        <div class="fg" style="margin-bottom:10px"><label>DimensiÃ³n del PETI</label>
          <select class="fsel" id="b${id}-dim" onchange="onDimChange(${id});previewB(${id});debouncedSave()">
            <option value="">â€” seleccionar dimensiÃ³n â€”</option>${dimOpts}
          </select></div>
        <div class="fg"><label>Capacidades institucionales impactadas</label>
          <div class="cap-inst-list" id="caplist-${id}"></div>
          <button class="cap-add-btn" onclick="addCapInst(${id})">+ Agregar capacidad</button>
        </div>
      </div>
      <!-- PASO 4 -->
      <div class="b3-step">
        <div class="step-tag">Paso 4 Â· RedacciÃ³n de la brecha</div>
        <div class="step-q">Se genera automÃ¡ticamente. Puede editar el texto final si lo necesita.</div>
        <textarea class="obs-add-inp" id="b${id}-redaccion" rows="5" style="width:100%;resize:none;font-style:italic"
          placeholder="Se completarÃ¡ automÃ¡ticamente al llenar los pasos anteriores..."
          oninput="state.brechas.find(x=>x.id===${id}).redaccion=this.value;debouncedSave()"></textarea>
      </div>
      <!-- PREVIEW -->
      <div class="b-preview-full">
        <div class="b-preview-lbl">Brecha formulada</div>
        <div class="b-preview-txt" id="bpt-${id}"><span class="blank">Complete los pasos anteriores...</span></div>
      </div>
    </div>`;
  document.getElementById('brechas-cont').appendChild(div);
  if(!restored){
    state.brechas.push({id, pills:[], causa:'', dim:'', caps:[], redaccion:''});
    // Agregar 1 campo de capacidad por defecto
    addCapInst(id);
  }
}

function onDimChange(id){
  previewB(id);debouncedSave();
}

function addCapInst(id, val=''){
  const list=document.getElementById(`caplist-${id}`);if(!list)return;
  const opts=CAP_INST.map(c=>`<option value="${c}"${c===val?' selected':''}>${c}</option>`).join('');
  const row=document.createElement('div');
  row.className='cap-inst-row';
  row.innerHTML=`<select class="fsel" style="flex:1"
    onchange="syncCaps(${id});previewB(${id});debouncedSave()">
    <option value="">â€” seleccionar capacidad â€”</option>${opts}
  </select>
  <button class="cap-inst-del" onclick="this.parentElement.remove();syncCaps(${id});previewB(${id});debouncedSave()">âœ•</button>`;
  list.appendChild(row);
}

function syncCaps(id){
  const list=document.getElementById(`caplist-${id}`);if(!list)return;
  const vals=[...list.querySelectorAll('select')].map(s=>s.value.trim()).filter(Boolean);
  const b=state.brechas.find(x=>x.id===id);if(b)b.caps=vals;
}

function addPill(id){
  const inp=document.getElementById(`obs-inp-${id}`);if(!inp)return;
  const val=inp.value.trim();if(!val)return;
  const b=state.brechas.find(x=>x.id===id);if(b&&!b.pills.includes(val))b.pills.push(val);
  renderPills(id);
  inp.value='';previewB(id);debouncedSave();
}

function removePill(id,val){
  const b=state.brechas.find(x=>x.id===id);
  if(b)b.pills=b.pills.filter(p=>p!==val);
  renderPills(id);previewB(id);debouncedSave();
}

function renderPills(id){
  const cont=document.getElementById(`pills-${id}`);if(!cont)return;
  const b=state.brechas.find(x=>x.id===id);if(!b)return;
  cont.innerHTML=b.pills.map(p=>`<span class="obs-pill">${p}<button onclick="removePill(${id},'${p.replace(/'/g,"\\'")}')">âœ•</button></span>`).join('');
}

function restoreBrechas(){
  state.brechaCount=0;document.getElementById('brechas-cont').innerHTML='';
  const saved=[...state.brechas];state.brechas=[];
  if(!saved.length){addBrecha();return;}
  saved.forEach(b=>{
    state.brechaCount=b.id-1;addBrecha(true);state.brechas.push(b);
    setTimeout(()=>{
      renderPills(b.id);
      const causa=document.getElementById(`b${b.id}-causa`);if(causa)causa.value=b.causa||'';
      const dim=document.getElementById(`b${b.id}-dim`);if(dim){dim.value=b.dim||'';onDimChange(b.id);}
      const list=document.getElementById(`caplist-${b.id}`);
      if(list){list.innerHTML='';(b.caps||[]).forEach(c=>addCapInst(b.id,c));if(!(b.caps||[]).length)addCapInst(b.id);}
      const red=document.getElementById(`b${b.id}-redaccion`);if(red)red.value=b.redaccion||'';
      previewB(b.id);
    },0);
  });
}

function removeBrecha(id){document.getElementById(`brecha-${id}`).remove();state.brechas=state.brechas.filter(b=>b.id!==id);debouncedSave();}

function previewB(id){
  const b=state.brechas.find(x=>x.id===id);if(!b)return;
  // sync state
  const causa=document.getElementById(`b${id}-causa`)?.value||'';
  const dim=document.getElementById(`b${id}-dim`)?.value||'';
  b.causa=causa;b.dim=dim;
  syncCaps(id);
  const caps=b.caps||[];
  const el=document.getElementById(`bpt-${id}`);if(!el)return;
  const hD=dim&&dim!=='',hCa=causa.trim().length>0,hC=caps.length>0;
  if(!hD&&!hCa&&!hC){el.innerHTML='<span class="blank">Complete los pasos anteriores...</span>';return;}
  const capStr=caps.length>1?caps.map((c,i)=>`<span class="fill">${c}</span>`).join(' y '):caps.length===1?`<span class="fill">${caps[0]}</span>`:'<span class="blank">[capacidad institucional]</span>';
  el.innerHTML=`Se identifica una brecha en la dimensiÃ³n de ${hD?`<span class="fill">${dim}</span>`:'<span class="blank">[dimensiÃ³n]</span>'} que impacta la capacidad de ${capStr}, como consecuencia de ${hCa?`<span class="fill">${causa}</span>`:'<span class="blank">[causa estructural]</span>'}.`;
  // Auto-fill redacciÃ³n si estÃ¡ vacÃ­a
  const redEl=document.getElementById(`b${id}-redaccion`);
  if(redEl&&!b.redaccion){
    const capTxt=caps.length>1?caps.join(' y '):caps[0]||'[capacidad]';
    redEl.value=hD&&hCa&&hC?`Se identifica una brecha en la dimensiÃ³n de ${dim} que impacta la capacidad de ${capTxt}, como consecuencia de ${causa}.`:'';
  }
}

// â”€â”€ B4 â”€â”€
function initB4(){
  document.getElementById('momento-grid').innerHTML=MOMENTOS.map(m=>`
    <div class="momento-card">
      <div class="m-hdr"><span class="m-icon">${m.icon}</span><span class="m-title">${m.n}. ${m.title}</span></div>
      <div class="m-body">
        <div class="m-q">${m.q}</div>
        <input class="m-input" id="m-${m.n}" placeholder="Nombre del participante..."
          oninput="state.momentos['${m.n}']=this.value;chipM('${m.n}');debouncedSave()">
        <div class="m-chip vacio" id="chip-${m.n}">Sin asignar</div>
      </div>
    </div>`).join('');
}
function restoreB4(){
  Object.entries(state.momentos).forEach(([n,name])=>{const el=document.getElementById(`m-${n}`);if(el){el.value=name;chipM(n);}});
  const rt=document.getElementById('relato-txt');if(rt&&state.relatoTxt)rt.value=state.relatoTxt;
}
function chipM(n){
  const val=document.getElementById(`m-${n}`)?.value.trim();
  const chip=document.getElementById(`chip-${n}`);if(!chip)return;
  chip.textContent=val?'ðŸ“¹ '+val:'Sin asignar';chip.className='m-chip '+(val?'asig':'vacio');
}
function refrescarBrechaSel(){
  const sel=document.getElementById('brecha-sel');const cur=sel.value;
  sel.innerHTML='<option value="">â€” seleccionar â€”</option>';
  state.brechas.forEach((b,i)=>{
    const dim=document.getElementById(`b${b.id}-dim`)?.value||b.dim||'';
    if(dim)sel.innerHTML+=`<option value="${b.id}">${i+1}. ${dim}</option>`;
  });
  sel.value=cur;actualizarBrecha();
}
function actualizarBrecha(){
  const id=parseInt(document.getElementById('brecha-sel').value);
  const el=document.getElementById('brecha-txt');
  if(!id){el.textContent='Seleccione una brecha del Bloque 3';el.style.fontStyle='italic';return;}
  const b=state.brechas.find(x=>x.id===id);
  const dim=document.getElementById(`b${id}-dim`)?.value||b?.dim||'';
  const causa=document.getElementById(`b${id}-causa`)?.value||b?.causa||'';
  const caps=(b?.caps||[]).join(' y ')||'';
  el.style.color='var(--navy)';el.style.fontStyle='normal';
  el.textContent=`Se identifica una brecha en la dimensiÃ³n de ${dim} que impacta la capacidad de ${caps}, como consecuencia de ${causa}.`;
}

// â”€â”€ PLENARIA â”€â”€
function abrirPlenaria(){
  persist();
  // Tapete
  const zonaInfo={green:{lbl:'ðŸŸ¢ DesempeÃ±o Adecuado',cls:'plg'},yellow:{lbl:'ðŸŸ¡ Parcial / En Riesgo',cls:'ply'},red:{lbl:'ðŸ”´ CrÃ­tico',cls:'plr'}};
  const tapeteHtml=['green','yellow','red'].map(lv=>{
    const zi=zonaInfo[lv];
    const dims=DIMS.filter(d=>state.semaforo[d.id]===lv);
    return `<div class="pl-zone ${zi.cls}">
      <div class="pl-zone-hdr">${zi.lbl}</div>
      ${dims.length?dims.map(d=>`<div class="pl-dim-item">
        <div class="pl-dim-name">${d.name}</div>
        ${state.evidencias[d.id]?`<div class="pl-dim-ev">"${state.evidencias[d.id]}"</div>`:''}
      </div>`).join(''):'<p style="font-size:12px;color:#bbb;text-align:center;font-style:italic">Ninguna</p>'}
    </div>`;
  }).join('');

  // GalerÃ­a agrupada por nivel
  const galeriaHtml=[{lv:'green',label:'ðŸŸ¢ Consolidadas'},{lv:'yellow',label:'ðŸŸ¡ Funcionales'},{lv:'amber',label:'ðŸŸ  FrÃ¡giles'},{lv:'red',label:'ðŸ”´ Declarativas'}]
    .map(g=>{
      const n=NLVL[g.lv];
      const caps=CAPS.filter(c=>state.capacidades[c.id]===g.lv);
      const rows=caps.length
        ?caps.map(c=>{
            const obs=state.obstaculos[c.id]||'';
            return `<div class="pl-cap-row">
              <div style="flex:1">
                <div class="pl-cap-name">${c.name}</div>
                ${obs?`<div class="pl-cap-obs pl-nivel-group ${n.cls}">âš  ${obs}</div>`:`<span class="pl-no-obs">Sin obstÃ¡culo registrado</span>`}
              </div>
            </div>`;
          }).join('')
        :`<div style="padding:10px 15px;font-size:12px;color:var(--muted);font-style:italic;background:var(--bg)">Ninguna capacidad en este nivel</div>`;
      return `<div class="pl-nivel-group ${n.cls}">
        <div class="pl-nivel-hdr"><span>${g.label}</span><span class="pl-nivel-cnt">${caps.length} capacidad${caps.length!==1?'es':''}</span></div>
        ${rows}
      </div>`;
    }).join('');

  // Brechas
  const brechasHtml=state.brechas.map((b,i)=>{
    const dim=document.getElementById(`b${b.id}-dim`)?.value||b.dim||'';
    const caps=(b.caps||[]);
    const causa=document.getElementById(`b${b.id}-causa`)?.value||b.causa||'';
    if(!dim&&!caps.length&&!causa)return'';
    const capStr=caps.length?caps.join(' y '):'___';
    return `<div class="pl-brecha">
      <div class="pl-brecha-num">Brecha ${i+1} Â· ${dim||'DimensiÃ³n sin definir'}</div>
      <div class="pl-brecha-txt">Se identifica una brecha en la dimensiÃ³n de <span class="fill">${dim||'___'}</span> que impacta la capacidad de <span class="fill">${capStr}</span>, como consecuencia de <span class="fill">${causa||'___'}</span>.</div>
    </div>`;
  }).join('');

  document.getElementById('modal-body').innerHTML=`
    <div class="modal-sec">
      <div class="modal-sec-title">Bloque 1 Â· SemÃ¡foro de dimensiones</div>
      <div class="pl-tapete">${tapeteHtml}</div>
    </div>
    <div class="modal-sec">
      <div class="modal-sec-title">Bloque 2 Â· Capacidades agrupadas por nivel</div>
      ${galeriaHtml}
    </div>
    <div class="modal-sec">
      <div class="modal-sec-title">Bloque 3 Â· Brechas formuladas</div>
      ${brechasHtml||'<p style="color:var(--muted);font-size:13px;font-style:italic">AÃºn no hay brechas formuladas.</p>'}
    </div>`;
  document.getElementById('modal-plenaria').classList.add('open');
}
function cerrarPlenaria(){document.getElementById('modal-plenaria').classList.remove('open');}

// â”€â”€ EXPORTAR â”€â”€
function exportar(num){
  persist();
  const sep='='.repeat(52),dash='-'.repeat(40);
  const lines=['TALLER PETI 2027 â€” RESULTADO GRUPO VIRTUAL',sep,`Exportado: ${new Date().toLocaleString('es-CO')}`,''];
  if(num>=1){
    lines.push('BLOQUE 1 Â· DIAGNÃ“STICO â€” SEMÃFORO',dash);
    DIMS.forEach(d=>{const lv=state.semaforo[d.id];lines.push(`${d.name}: ${lv?SLV[lv]:'Sin respuesta'}`);const ev=state.evidencias[d.id];if(ev?.trim())lines.push(`  Evidencia: ${ev}`);});
    lines.push('');
  }
  if(num>=2){
    lines.push('BLOQUE 2 Â· CAPACIDADES â€” AGRUPADAS POR NIVEL',dash);
    ['green','yellow','amber','red'].forEach(lv=>{
      const caps=CAPS.filter(c=>state.capacidades[c.id]===lv);if(!caps.length)return;
      lines.push(`\n${NLVL[lv].icon} ${NLVL[lv].label.toUpperCase()}:`);
      caps.forEach(c=>{lines.push(`  ${c.name}`);const obs=state.obstaculos[c.id];if(obs?.trim())lines.push(`    ObstÃ¡culo: ${obs}`);});
    });
    lines.push('');
  }
  if(num>=3){
    lines.push('BLOQUE 3 Â· BRECHAS FORMULADAS',dash);
    state.brechas.forEach((b,i)=>{
      const dim=document.getElementById(`b${b.id}-dim`)?.value||b.dim||'';
      const caps=(b.caps||[]);
      const causa=document.getElementById(`b${b.id}-causa`)?.value||b.causa||'';
      if(!dim&&!caps.length&&!causa)return;
      const capStr=caps.join(' / ')||'(sin capacidad)';
      lines.push(`Brecha ${i+1}: ${dim}`);
      if(b.pills?.length)lines.push(`  ObstÃ¡culos agrupados: ${b.pills.join(' | ')}`);
      lines.push(`  Causa estructural: ${causa}`);
      lines.push(`  Capacidades institucionales impactadas: ${capStr}`);
      lines.push(`  â†’ Se identifica una brecha en la dimensiÃ³n de ${dim} que impacta la capacidad de ${capStr}, como consecuencia de ${causa}.`,'');
    });
  }
  if(num>=4){
    lines.push('BLOQUE 4 Â· RELATO ESTRATÃ‰GICO',dash);
    MOMENTOS.forEach(m=>lines.push(`Momento ${m.n} â€” ${m.title}: ${state.momentos[m.n]||'Sin asignar'}`));
    const rt=document.getElementById('relato-txt')?.value||'';
    if(rt)lines.push('','Relato:',rt);
    lines.push('');
  }
  lines.push(sep,'Taller PETI 2027 Â· ANH OTI Â· Grupo Virtual');
  const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`PETI2027_grupo_virtual_${num===4?'completo':'bloque'+num}.txt`;a.click();
  showToast('âœ“ Archivo descargado');
}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}

// â”€â”€ INIT â”€â”€
load();
initB1();restoreB1();
initB2();restoreB2();
restoreBrechas();
initB4();restoreB4();
</script>
</body>
</html>
